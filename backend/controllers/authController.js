import User from '../models/User.js';
import Profile from '../models/Profile.js';
import Agent from '../models/Agent.js';
import AgentReferral from '../models/AgentReferral.js';
import UserRole from '../models/UserRole.js';
import { generateToken, generateRefreshToken } from '../config/jwt.js';
import axios from 'axios';

// Register user
export const register = async (req, res) => {
  try {
    const { fullName, username, email, password, phoneNumber, referralCode } = req.body;

    console.log('üöÄ User registration process started');

    // Check if username already exists
    const existingProfile = await Profile.findOne({ username });
    if (existingProfile) {
      return res.status(400).json({
        success: false,
        error: 'T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i'
      });
    }

    // Check if email already exists
    const existingUser = await User.findOne({ email });
    if (existingUser) {
      return res.status(400).json({
        success: false,
        error: 'Email ƒë√£ t·ªìn t·∫°i'
      });
    }

    // Register with external game API
    console.log(`üìù Registering player externally - ${username}, ${fullName}`);
    const externalRequestData = {
      Username: username,
      DisplayName: fullName,
      Agent: process.env.GAME_AGENT || 'VND1_dimonbet',
      CompanyKey: process.env.GAME_COMPANY_KEY || 'C6012BA39EB643FEA4F5CD49AF138B02',
      ServerId: process.env.GAME_SERVER_ID || '206.206.126.141',
    };

    console.log('üì§ Calling external register API:', externalRequestData);

    try {
      const externalResponse = await axios.post(
        `${process.env.GAME_API_URL}/player/register-player.aspx`,
        externalRequestData,
        {
          headers: {
            'Content-Type': 'application/json',
          },
        }
      );

      console.log(`üì• External API response status: ${externalResponse.status}`);
      console.log('üì• External API response data:', externalResponse.data);

      const externalSuccess = externalResponse.status === 200 && externalResponse.data?.error?.msg === 'No Error';
      
      if (!externalSuccess) {
        console.log('‚ùå External player registration failed:', externalResponse.data?.error?.msg || 'Unknown error');
        return res.status(400).json({
          success: false,
          error: 'T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i',
          details: externalResponse.data?.error?.msg || 'Registration failed'
        });
      }

      console.log('‚úÖ External player registration successful');
    } catch (externalError) {
      console.error('‚ùå External API error:', externalError.response?.data || externalError.message);
      return res.status(400).json({
        success: false,
        error: 'Kh√¥ng th·ªÉ ƒëƒÉng k√Ω v·ªõi h·ªá th·ªëng game',
        details: externalError.response?.data?.error?.msg || externalError.message
      });
    }

    // Create user in database
    console.log('üìù Creating user in database');
    const user = new User({
      email,
      password,
      emailConfirmed: true
    });

    await user.save();
    console.log('‚úÖ User created successfully in database');

    // Create user profile
    const profile = new Profile({
      userId: user._id,
      username,
      fullName,
      phoneNumber,
      balance: 0
    });

    await profile.save();
    console.log('‚úÖ Profile created successfully');

    // Create user role
    const userRole = new UserRole({
      userId: user._id,
      role: 'user'
    });

    await userRole.save();
    console.log('‚úÖ User role created successfully');

    // Handle referral if provided
    if (referralCode) {
      console.log('üîó Referral code provided:', referralCode);
      try {
        const agent = await Agent.findOne({ referralCode });
        
        if (agent) {
          // Update profile with referral
          profile.referredBy = agent._id;
          await profile.save();

          // Create referral record
          const agentReferral = new AgentReferral({
            agentId: agent._id,
            referredUserId: user._id,
            status: 'active',
            commissionEarned: 0
          });

          await agentReferral.save();

          // Update agent referral count
          await agent.incrementReferralCount();

          console.log('‚úÖ Referral processed successfully');
        } else {
          console.log('‚ÑπÔ∏è Referral code not found or no matching agent');
        }
      } catch (referralError) {
        console.error('‚ö†Ô∏è Referral processing error:', referralError);
      }
    }

    // Generate tokens
    const token = generateToken({ userId: user._id, email: user.email });
    const refreshToken = generateRefreshToken({ userId: user._id });

    console.log('‚úÖ Registration process completed successfully');

    res.status(201).json({
      success: true,
      message: 'ƒêƒÉng k√Ω th√†nh c√¥ng',
      data: {
        user: {
          id: user._id,
          email: user.email,
          username: username,
          fullName: fullName
        },
        token,
        refreshToken
      }
    });

  } catch (error) {
    console.error('üí• Registration error:', error);
    res.status(500).json({
      success: false,
      error: 'L·ªói server n·ªôi b·ªô',
      details: error.message
    });
  }
};

// Login user
export const login = async (req, res) => {
  try {
    const { username, password } = req.body;
    const clientIp = req.ip || req.connection.remoteAddress;

    console.log(`üë§ Processing login for username: ${username}`);

    // Find user profile by username
    const profile = await Profile.findOne({ username }).populate('userId');
    if (!profile || !profile.userId) {
      return res.status(400).json({
        success: false,
        error: 'T√™n ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i'
      });
    }

    const user = profile.userId;

    // Verify password
    const isPasswordValid = await user.comparePassword(password);
    if (!isPasswordValid) {
      return res.status(401).json({
        success: false,
        error: 'M·∫≠t kh·∫©u kh√¥ng ch√≠nh x√°c'
      });
    }

    // Update last login
    await user.updateLastLogin(clientIp);

    // Get user role
    const userRole = await UserRole.findOne({ userId: user._id });

    // Generate tokens
    const token = generateToken({ userId: user._id, email: user.email });
    const refreshToken = generateRefreshToken({ userId: user._id });

    console.log(`‚úÖ Login successful for user: ${username}`);

    res.json({
      success: true,
      message: 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng',
      data: {
        user: {
          id: user._id,
          email: user.email,
          username: profile.username,
          fullName: profile.fullName,
          balance: profile.balance,
          role: userRole?.role || 'user'
        },
        token,
        refreshToken
      }
    });

  } catch (error) {
    console.error('üí• Login error:', error);
    res.status(500).json({
      success: false,
      error: 'L·ªói server n·ªôi b·ªô',
      details: error.message
    });
  }
};

// Check username availability
export const checkUsername = async (req, res) => {
  try {
    const { username } = req.body;

    // Validate username format
    if (!username || username.length < 3) {
      return res.status(400).json({
        success: false,
        error: 'T√™n ng∆∞·ªùi d√πng ph·∫£i c√≥ √≠t nh·∫•t 3 k√Ω t·ª±'
      });
    }

    const usernameRegex = /^[a-zA-Z0-9_]+$/;
    if (!usernameRegex.test(username)) {
      return res.status(400).json({
        success: false,
        error: 'T√™n ng∆∞·ªùi d√πng ch·ªâ ƒë∆∞·ª£c ch·ª©a ch·ªØ c√°i, s·ªë v√† d·∫•u g·∫°ch d∆∞·ªõi'
      });
    }

    // Check if username already exists
    const existingProfile = await Profile.findOne({ username });
    
    res.json({
      success: true,
      data: {
        isAvailable: !existingProfile,
        username: username
      }
    });

  } catch (error) {
    console.error('üí• Check username error:', error);
    res.status(500).json({
      success: false,
      error: 'L·ªói server n·ªôi b·ªô',
      details: error.message
    });
  }
};

// Get current user
export const getCurrentUser = async (req, res) => {
  try {
    const user = await User.findById(req.user._id).select('-password');
    const profile = await Profile.findOne({ userId: req.user._id });
    const userRole = await UserRole.findOne({ userId: req.user._id });

    if (!user || !profile) {
      return res.status(404).json({
        success: false,
        error: 'Ng∆∞·ªùi d√πng kh√¥ng t·ªìn t·∫°i'
      });
    }

    res.json({
      success: true,
      data: {
        user: {
          id: user._id,
          email: user.email,
          username: profile.username,
          fullName: profile.fullName,
          phoneNumber: profile.phoneNumber,
          avatarUrl: profile.avatarUrl,
          balance: profile.balance,
          role: userRole?.role || 'user',
          lastLoginAt: user.lastLoginAt,
          createdAt: user.createdAt
        }
      }
    });

  } catch (error) {
    console.error('üí• Get current user error:', error);
    res.status(500).json({
      success: false,
      error: 'L·ªói server n·ªôi b·ªô',
      details: error.message
    });
  }
};

// Refresh token
export const refreshToken = async (req, res) => {
  try {
    const { refreshToken } = req.body;

    if (!refreshToken) {
      return res.status(400).json({
        success: false,
        error: 'Refresh token l√† b·∫Øt bu·ªôc'
      });
    }

    const decoded = jwt.verify(refreshToken, process.env.JWT_SECRET);
    const user = await User.findById(decoded.userId);

    if (!user) {
      return res.status(401).json({
        success: false,
        error: 'Refresh token kh√¥ng h·ª£p l·ªá'
      });
    }

    const newToken = generateToken({ userId: user._id, email: user.email });
    const newRefreshToken = generateRefreshToken({ userId: user._id });

    res.json({
      success: true,
      data: {
        token: newToken,
        refreshToken: newRefreshToken
      }
    });

  } catch (error) {
    console.error('üí• Refresh token error:', error);
    res.status(401).json({
      success: false,
      error: 'Refresh token kh√¥ng h·ª£p l·ªá'
    });
  }
};

// Logout
export const logout = async (req, res) => {
  try {
    // In a more sophisticated implementation, you might want to blacklist the token
    res.json({
      success: true,
      message: 'ƒêƒÉng xu·∫•t th√†nh c√¥ng'
    });
  } catch (error) {
    console.error('üí• Logout error:', error);
    res.status(500).json({
      success: false,
      error: 'L·ªói server n·ªôi b·ªô'
    });
  }
};
